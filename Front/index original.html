<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Security Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #030712; }
        .loader { border: 4px solid #374151; border-top: 4px solid #10b981; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-link.active { background-color: #10b981; color: white; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-950 text-white">

    <div id="app"></div>

    <script type="module">
        const app = document.getElementById('app');
        const API_BASE_URL = 'http://localhost:5000/api';

        const state = {
            isAuthenticated: false,
            user: null,
            token: localStorage.getItem('token'),
            paths: [],
            currentPath: null,
            currentRoom: null,
            activeTask: null,
        };

        // --- API UTILITY ---
        async function apiFetch(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (state.token) headers['x-auth-token'] = state.token;
            const config = { method, headers };
            if (body) config.body = JSON.stringify(body);

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ msg: '서버와 통신할 수 없습니다.' }));
                    throw new Error(errorData.msg);
                }
                if (response.status === 204) return null;
                return await response.json();
            } catch (error) {
                console.error('API Fetch Error:', error);
                throw error;
            }
        }

        // --- TEMPLATES ---
        const FullScreenLoader = () => `<div class="fixed inset-0 bg-gray-950 flex justify-center items-center z-50"><div class="loader"></div></div>`;

        const AuthPageTemplate = (isLoginView = true, error = '') => `
            <div class="min-h-screen bg-gray-950 flex flex-col items-center justify-center p-4 animate-fade-in">
                <div class="text-center mb-8"><i data-lucide="shield-check" class="mx-auto text-green-500 w-16 h-16"></i><h1 class="text-5xl font-bold text-white mt-4">CYBER PLATFORM</h1><p class="text-gray-300 text-lg mt-2">지식의 방패로 당신의 디지털 세계를 방어하세요.</p></div>
                <div class="w-full max-w-md bg-gray-900 p-8 rounded-2xl shadow-lg border border-gray-800">
                    <h2 class="text-3xl font-bold text-center text-green-400 mb-2">${isLoginView ? '로그인' : '회원가입'}</h2>
                    ${error ? `<p class="bg-red-500/20 text-red-300 p-3 rounded-md text-center my-4">${error}</p>` : ''}
                    <form id="auth-form">
                        ${!isLoginView ? `<div class="mb-4 relative"><i data-lucide="user" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i><input type="text" name="username" placeholder="사용자 이름" required class="w-full bg-gray-800 p-3 pl-10 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"/></div>` : ''}
                        <div class="mb-4 relative"><i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i><input type="email" name="email" placeholder="이메일 주소" required class="w-full bg-gray-800 p-3 pl-10 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"/></div>
                        <div class="mb-6 relative"><i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i><input type="password" name="password" placeholder="비밀번호" required minLength="6" class="w-full bg-gray-800 p-3 pl-10 rounded-lg border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500"/></div>
                        <button type="submit" class="w-full bg-green-600 font-bold py-3 rounded-lg hover:bg-green-700 transition-colors"> ${isLoginView ? '로그인' : '계정 생성'}</button>
                    </form>
                    <p class="text-center text-gray-400 mt-6">${isLoginView ? "계정이 없으신가요? " : "이미 계정이 있으신가요? "}<button id="toggle-auth-view" class="text-green-400 hover:text-green-300 font-semibold">${isLoginView ? '회원가입' : '로그인'}</button></p>
                </div>
            </div>`;

        const MainLayoutTemplate = (page) => `
            <div class="flex h-screen bg-gray-950">
                <nav class="w-64 bg-gray-900 border-r border-gray-800 p-6 flex flex-col hidden sm:flex">
                    <a href="#/dashboard" class="flex items-center gap-3 mb-10"><i data-lucide="shield-half" class="w-10 h-10 text-green-500"></i><span class="text-xl font-bold">CyberSec</span></a>
                    <ul class="space-y-3">
                        <li><a href="#/dashboard" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors ${page === 'dashboard' ? 'active' : ''}"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> 대시보드</a></li>
                        <li><a href="#/profile" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors ${page === 'profile' ? 'active' : ''}"><i data-lucide="user-circle" class="w-5 h-5"></i> 프로필</a></li>
                        <li><a href="#/about" class="nav-link flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors ${page === 'about' ? 'active' : ''}"><i data-lucide="info" class="w-5 h-5"></i> About</a></li>
                    </ul>
                    <div class="mt-auto">
                        <div class="p-4 bg-gray-800 rounded-lg text-center">
                            <p class="text-sm text-gray-400">${state.user?.username || 'User'}</p>
                            <p class="text-xs text-yellow-400">${state.user?.points || 0} Points</p>
                            <button id="logout-btn" class="w-full text-sm mt-4 bg-red-600/80 hover:bg-red-600 px-3 py-1.5 rounded-md">로그아웃</button>
                        </div>
                    </div>
                </nav>
                <main id="main-content" class="flex-1 overflow-y-auto p-4 sm:p-8"></main>
            </div>`;

        const DashboardPageTemplate = () => `
            <div class="animate-fade-in">
                <div class="bg-gradient-to-r from-green-500/10 via-gray-950 to-gray-950 p-8 mb-8 rounded-2xl border border-green-500/20 flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl md:text-4xl font-bold">환영합니다, ${state.user.username}님!</h1>
                        <p class="text-gray-300 mt-2">오늘도 새로운 지식으로 당신의 디지털 세계를 방어해 보세요.</p>
                    </div>
                    <i data-lucide="binary" class="w-16 h-16 text-green-500/30 hidden md:block"></i>
                </div>
                <h2 class="text-3xl font-bold mb-6">학습 경로</h2>
                <div id="paths-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>
            </div>`;

        const ProfilePageTemplate = () => `
             <div class="animate-fade-in">
                <h1 class="text-4xl font-bold mb-8">프로필</h1>
                <div class="bg-gray-900 p-8 rounded-2xl border border-gray-800 max-w-2xl mx-auto">
                    <div class="flex flex-col sm:flex-row items-center gap-6 mb-8 text-center sm:text-left">
                         <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center text-gray-900 text-4xl font-bold flex-shrink-0">${state.user.username.charAt(0).toUpperCase()}</div>
                         <div><h2 class="text-3xl font-bold">${state.user.username}</h2><p class="text-gray-400">${state.user.email}</p></div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-6 rounded-lg text-center"><p class="text-sm text-gray-400">획득 점수</p><p class="text-3xl font-bold text-yellow-400">${state.user.points}</p></div>
                        <div class="bg-gray-800 p-6 rounded-lg text-center"><p class="text-sm text-gray-400">완료한 과제</p><p class="text-3xl font-bold">${state.user.completedTasks.length}</p></div>
                    </div>
                </div>
            </div>`;

        const AboutPageTemplate = () => `
             <div class="animate-fade-in max-w-4xl mx-auto">
                <h1 class="text-4xl font-bold mb-8">About Cyber Platform</h1>
                <div class="prose prose-invert prose-lg max-w-none prose-h2:text-green-400"><h2>우리의 미션</h2><p>Cyber Platform은 누구나 사이버 보안의 세계에 쉽게 접근하고, 실질적인 지식을 재미있게 학습할 수 있는 환경을 제공하는 것을 목표로 합니다. 복잡하고 어려운 보안 개념을 현실적인 시나리오와 상호작용적인 과제를 통해 풀어냄으로써, 이론과 실무의 간극을 줄이고자 합니다.</p><h2>무엇을 배울 수 있나요?</h2><p>이 플랫폼에서는 웹 해킹, 시스템 해킹, 네트워크 분석, 디지털 포렌식 등 다양한 사이버 보안 분야의 핵심 주제를 다룹니다. 각 학습 경로는 기초 개념부터 시작하여 심화적인 기술까지 체계적으로 구성되어 있어, 여러분의 수준에 맞춰 학습을 진행할 수 있습니다.</p><p>가상 시나리오에 몰입하여 주니어 분석가가 되어보거나, 퀴즈를 풀며 지식을 점검하고, 실제와 유사한 환경에서 문제 해결 능력을 키워보세요.</p></div>
            </div>`;
        
        const PathPageTemplate = (path) => `
            <div class="animate-fade-in">
                <a href="#/dashboard" class="flex items-center gap-2 text-green-400 mb-6 hover:text-green-300"><i data-lucide="arrow-left" class="w-5 h-5"></i> 모든 학습 경로 보기</a>
                <h1 class="text-4xl font-bold mb-2">${path.title}</h1>
                <p class="text-gray-400 text-lg mb-8">${path.description}</p>
                <div id="rooms-container" class="space-y-4"></div>
            </div>`;
        
        const RoomPageTemplate = (pathId) => `
            <div class="flex h-screen bg-gray-900 font-sans">
                <div id="room-sidebar" class="w-full md:w-1/3 lg:w-1/4 bg-gray-900 p-6 border-r border-gray-800 flex flex-col">
                    <a href="#/path/${pathId}" class="flex items-center gap-2 text-green-400 mb-6 hover:text-green-300"><i data-lucide="arrow-left" class="w-5 h-5"></i> 방 목록으로 돌아가기</a>
                    <div id="sidebar-content" class="overflow-y-auto"></div>
                </div>
                <main id="task-content" class="w-full md:w-2/3 lg:w-3/4 p-8 overflow-y-auto relative bg-gray-950"></main>
            </div>`;

        // --- RENDER FUNCTIONS ---
        function renderPage(pageName, contentTemplate) {
            const mainLayout = document.querySelector('nav')?.closest('.flex.h-screen');
            if (!mainLayout) {
                app.innerHTML = MainLayoutTemplate(pageName);
            } else {
                // Update active link on existing layout
                 document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === `#/${pageName}`) {
                        link.classList.add('active');
                    }
                });
            }
            document.getElementById('main-content').innerHTML = contentTemplate;
            document.getElementById('logout-btn')?.addEventListener('click', logout);
            lucide.createIcons();
        }

        async function renderDashboardPage() {
            renderPage('dashboard', DashboardPageTemplate());
            const pathsContainer = document.getElementById('paths-container');
            pathsContainer.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                state.paths = await apiFetch('/paths');
                if (!state.paths || state.paths.length === 0) {
                    pathsContainer.innerHTML = `<p class="text-gray-400 col-span-full">아직 생성된 학습 경로가 없습니다.</p>`;
                    return;
                }
                pathsContainer.innerHTML = state.paths.map(path => {
                    const levelStyles = {'초급': 'border-blue-400 text-blue-300 bg-blue-500/10', '중급': 'border-yellow-400 text-yellow-300 bg-yellow-500/10', '고급': 'border-red-400 text-red-300 bg-red-500/10'};
                    return `
                        <a href="#/path/${path._id}" class="path-card bg-gray-900 rounded-xl p-6 border border-gray-800 hover:border-green-500 hover:scale-[1.02] transition-all flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-4"><i data-lucide="book-open" class="text-green-400"></i><span class="px-3 py-1 text-sm font-bold rounded-full border ${levelStyles[path.level]}">${path.level}</span></div>
                                <h2 class="text-2xl font-bold mb-2">${path.title}</h2><p class="text-gray-400 mb-6">${path.description}</p>
                            </div>
                        </a>`;
                }).join('');
                lucide.createIcons();
            } catch (error) { pathsContainer.innerHTML = `<p class="text-red-400">학습 경로 로딩 실패: ${error.message}</p>`;}
        }
        
        function renderProfilePage() { renderPage('profile', ProfilePageTemplate()); }
        function renderAboutPage() { renderPage('about', AboutPageTemplate()); }
        
        async function renderPathPage(pathId) {
            if (!state.paths || state.paths.length === 0) {
                try { state.paths = await apiFetch('/paths'); }
                catch(e) { app.innerHTML = `<p class="p-8 text-red-400">데이터 로딩 실패</p>`; return; }
            }
            const path = state.paths.find(p => p._id === pathId);
            if (!path) { app.innerHTML = `<p class="p-8 text-red-400">학습 경로를 찾을 수 없습니다.</p>`; return; }
            state.currentPath = path;
            
            renderPage('dashboard', PathPageTemplate(path));
            const roomsContainer = document.getElementById('rooms-container');
            if (!path.rooms || path.rooms.length === 0) {
                roomsContainer.innerHTML = `<div class="text-center py-16 bg-gray-900 rounded-lg"><p class="text-gray-400">이 경로에는 아직 학습 방이 없습니다.</p></div>`;
            } else {
                roomsContainer.innerHTML = path.rooms.map(room => `
                    <a href="#/room/${room._id}" class="bg-gray-900 rounded-lg p-6 border border-gray-800 flex items-center justify-between hover:border-green-500 transition-colors cursor-pointer">
                        <div><h2 class="text-xl font-bold">${room.title}</h2><p class="text-gray-400 mt-1">${room.description}</p></div>
                        <i data-lucide="chevron-right" class="w-6 h-6"></i>
                    </a>`).join('');
            }
            lucide.createIcons();
        }
        
        async function renderRoomPage(roomId) {
            app.innerHTML = FullScreenLoader();
            try {
                const room = await apiFetch(`/rooms/${roomId}`);
                state.currentRoom = room;

                let pathId = state.currentPath?._id;
                if (!pathId) {
                     if (!state.paths || state.paths.length === 0) state.paths = await apiFetch('/paths');
                     for (const path of state.paths) {
                        if (path.rooms.some(r => r._id === roomId)) {
                           pathId = path._id; state.currentPath = path; break;
                        }
                    }
                }
                
                app.innerHTML = RoomPageTemplate(pathId);
                renderRoomSidebar();
                renderTaskContent(room.tasks[0]);
            } catch (error) {
                app.innerHTML = `<p class="p-8 text-red-400">학습 방 로딩 실패: ${error.message}</p>`;
            }
        }
        
        function renderRoomSidebar() {
            const sidebar = document.getElementById('sidebar-content');
            const room = state.currentRoom;
            if(!room) return;
            const isTaskCompleted = (taskId) => state.user?.completedTasks.includes(taskId);

            sidebar.innerHTML = `
                <h1 class="text-2xl font-bold text-green-400 mb-2">${room.title}</h1>
                <p class="text-gray-400 mb-6 text-sm">${room.description}</p>
                <ul>
                    ${room.tasks.map((task, index) => `
                        <li data-task-id="${task._id}" class="task-item p-3 my-2 rounded-lg cursor-pointer flex items-center justify-between transition-colors ${state.activeTask?._id === task._id ? 'bg-green-600/80 text-white' : 'bg-gray-800 hover:bg-gray-700'}">
                            <span>Task ${index + 1}: ${task.title}</span>
                            ${isTaskCompleted(task._id) ? '<i data-lucide="star" class="text-yellow-400 fill-current w-4 h-4"></i>' : ''}
                        </li>`).join('')}
                </ul>`;

            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', () => {
                    const taskId = item.dataset.taskId;
                    const task = state.currentRoom.tasks.find(t => t._id === taskId);
                    renderTaskContent(task);
                });
            });
            lucide.createIcons();
        }

        function renderTaskContent(task) {
            state.activeTask = task;
            const taskContainer = document.getElementById('task-content');
            if(!task) { taskContainer.innerHTML = '<p>과제를 선택하세요.</p>'; return; }

            taskContainer.innerHTML = `
                <div class="animate-fade-in"><h2 class="text-3xl font-bold mb-4">${task.title}</h2>
                <div class="prose prose-invert max-w-none prose-pre:bg-gray-800 prose-p:text-gray-300 prose-blockquote:border-green-500">${task.content}</div>
                ${task.taskType === 'quiz' ? `
                <form id="quiz-form" class="mt-8 p-6 bg-gray-900 border border-gray-800 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3 text-green-300">${task.question}</h3>
                    <div class="flex flex-col gap-4">
                        <input type="text" name="answer" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="정답 입력..." required>
                        <div id="hint-display" class="h-8 text-gray-400 font-mono text-lg tracking-widest flex items-center"></div>
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <button type="submit" class="w-full sm:w-auto flex-grow px-6 py-3 bg-green-600 hover:bg-green-700 rounded-md font-bold whitespace-nowrap">제출</button>
                            <button type="button" id="hint-btn" class="w-full sm:w-auto px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-md font-bold whitespace-nowrap">힌트 보기</button>
                        </div>
                    </div>
                </form>` : ''}
                <div id="feedback-container" class="mt-4"></div></div>`;
            
            if (task.taskType === 'quiz') {
                document.getElementById('quiz-form').addEventListener('submit', async e => {
                    e.preventDefault();
                    const answer = e.target.answer.value;
                    const feedbackContainer = document.getElementById('feedback-container');
                    try {
                        const result = await apiFetch(`/tasks/${task._id}/submit`, 'POST', { answer });
                        if(result.correct) {
                            state.user = result.user;
                            feedbackContainer.innerHTML = `<p class="p-4 rounded-md bg-green-900 text-green-300">${result.msg}</p>`;
                            renderRoomSidebar();
                            // Update user info in the main layout without full re-render
                            const userPointsElement = document.querySelector('.mt-auto .text-yellow-400');
                            if(userPointsElement) userPointsElement.textContent = `${state.user.points} Points`;
                        } else {
                            feedbackContainer.innerHTML = `<p class="p-4 rounded-md bg-red-900 text-red-300">${result.msg}</p>`;
                        }
                    } catch(err) { feedbackContainer.innerHTML = `<p class="p-4 rounded-md bg-red-900 text-red-300">${err.message}</p>`; }
                });

                document.getElementById('hint-btn').addEventListener('click', (e) => {
                    const hintDisplay = document.getElementById('hint-display');
                    if (task.answer && hintDisplay.textContent === '') {
                        const hintText = task.answer.replace(/[^\s]/g, '_');
                        hintDisplay.textContent = hintText;
                        e.target.disabled = true;
                        e.target.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                });
            }
            renderRoomSidebar();
            document.querySelectorAll('pre code').forEach(hljs.highlightElement);
        }

        const routes = {
            '#/dashboard': renderDashboardPage,
            '#/profile': renderProfilePage,
            '#/about': renderAboutPage,
            '#/path/': renderPathPage,
            '#/room/': renderRoomPage,
        };
        
        async function router() {
            const path = window.location.hash || '#/dashboard';
            if (!state.isAuthenticated) {
                renderAuthPage();
                return;
            }
            
            const routeKey = Object.keys(routes).find(key => path.startsWith(key)) || '#/dashboard';
            const renderFunc = routes[routeKey];
            const param = routeKey.endsWith('/') ? path.substring(routeKey.length) : null;
            
            try { 
                await renderFunc(param);
            } catch(err) { 
                console.error("Routing Error:", err);
                const mainContent = document.getElementById('main-content');
                if (mainContent) mainContent.innerHTML = `<p class="text-red-400">페이지를 로드할 수 없습니다: ${err.message}</p>`;
                else app.innerHTML = `<p class="text-red-400">페이지를 로드할 수 없습니다: ${err.message}</p>`;
            }
        }

        async function loadUser() {
            state.token = localStorage.getItem('token');
            if (state.token) {
                try {
                    state.user = await apiFetch('/auth');
                    state.isAuthenticated = true;
                } catch (err) {
                    logout(true);
                }
            } else {
                state.isAuthenticated = false;
            }
        }
        
        function logout(isSilent = false) {
            localStorage.removeItem('token');
            Object.assign(state, { isAuthenticated: false, user: null, token: null });
            if (!isSilent) {
                window.location.hash = '#/login';
                renderAuthPage();
            }
        }
        
        function renderAuthPage(isLogin = true, error = '') {
            app.innerHTML = AuthPageTemplate(isLogin, error);
            document.getElementById('toggle-auth-view').addEventListener('click', () => renderAuthPage(!isLogin));
            document.getElementById('auth-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                try {
                    const endpoint = isLogin ? '/auth/login' : '/auth/register';
                    const result = await apiFetch(endpoint, 'POST', data);
                    localStorage.setItem('token', result.token);
                    await init();
                } catch (err) {
                    renderAuthPage(isLogin, err.message);
                }
            });
            lucide.createIcons();
        }

        async function init() {
            app.innerHTML = FullScreenLoader();
            await loadUser();
            await router();
        }

        window.addEventListener('hashchange', router);
        init();
    </script>
</body>
</html>
